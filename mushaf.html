<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Mushaf Dinamis V1/V2 + Terjemah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #fefcf8;
      padding: 1em;
      font-family: sans-serif;
      direction: rtl;
    }
    h2 { text-align: center; }
    .controls {
      direction: ltr;
      max-width: 720px;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
      align-items: flex-end;
    }
    label { font-size: 0.9em; }
    select, button {
      font-size: 1em;
      padding: 0.5em;
    }
    .version-buttons {
      margin-top: 1em;
      text-align: center;
    }
    .page-container {
      font-size: 2.5em;
      line-height: 1.6;
      text-align: center;
      user-select: text;
      margin: 2em auto;
      opacity: 0;
      transition: opacity 0.3s ease;
      display: none;
      word-spacing: -0.08em;
      max-width: 700px;
    }
    .word {
      display: inline-block;
      margin: 0;
      cursor: default;
    }
    .translation {
      font-family: sans-serif;
      font-size: 1em;
      color: #333;
      direction: ltr;
      text-align: center;
      margin-top: 1em;
    }
    .word-translation {
      display: block;
      font-size: 0.4em;
      color: #666;
    }
    @media (max-width: 768px) {
      .page-container { font-size: 1.5em; }
    }
  </style>
</head>
<body>

<h2>ğŸ“– Al-Qur'an Dinamis (V1/V2 + Terjemah)</h2>

<div class="controls">
  <label>Surah
    <select id="surahSelect"></select>
  </label>
  <label>Ayat
    <select id="ayahSelect"></select>
  </label>
  <label>Jumlah Kata
    <select id="wordCount"><option value="0">Semua</option></select>
  </label>
  <label>Terjemah
    <select id="translationSelect">
      <option value="indonesian_complex">Indonesian â€“ Complex</option>
      <option value="indonesian_sabiq">Indonesian â€“ Sabiq</option>
      <option value="indonesian_affairs">Indonesian â€“ Affairs</option>
      <option value="english_rwwad">English â€“ RWWAD</option>
      <option value="english_saheeh">English â€“ Saheeh</option>
      <option value="english_hilali_khan">English â€“ Hilali Khan</option>
      <option value="french_rashid">French â€“ Rashid</option>
      <option value="french_montada">French â€“ Montada</option>
      <option value="spanish_montada_eu">Spanish â€“ Montada (EU)</option>
      <option value="spanish_garcia">Spanish â€“ Garcia</option>
      <option value="spanish_montada_latin">Spanish â€“ Montada (Latin)</option>
      <option value="portuguese_nasr">Portuguese â€“ Nasr</option>
      <option value="german_bubenheim">German â€“ Bubenheim</option>
      <option value="romanian_project">Romanian â€“ Project</option>
      <option value="dutch_center">Dutch â€“ Center</option>
      <option value="turkish_rwwad">Turkish â€“ RWWAD</option>
      <option value="turkish_shaban">Turkish â€“ Shaban</option>
      <option value="turkish_shahin">Turkish â€“ Shahin</option>
      <option value="azeri_musayev">Azeri â€“ Musayev</option>
      <option value="macedonian_group">Macedonian â€“ Group</option>
      <option value="albanian_nahi">Albanian â€“ Nahi</option>
      <option value="bosnian_rwwad">Bosnian â€“ RWWAD</option>
      <option value="bosnian_mihanovich">Bosnian â€“ Mihanovich</option>
      <option value="serbian_rwwad">Serbian â€“ RWWAD</option>
      <option value="croatian_rwwad">Croatian â€“ RWWAD</option>
      <option value="lithuanian_rwwad">Lithuanian â€“ RWWAD</option>
      <option value="uzbek_rwwad">Uzbek â€“ RWWAD</option>
      <option value="uzbek_mansour">Uzbek â€“ Mansour</option>
      <option value="tajik_arifi">Tajik â€“ Arifi</option>
      <option value="kyrgyz_hakimov">Kyrgyz â€“ Hakimov</option>
      <option value="tagalog_rwwad">Tagalog â€“ RWWAD</option>
      <option value="bisayan_rwwad">Bisayan â€“ RWWAD</option>
      <option value="chinese_suliman">Chinese â€“ Suliman</option>
      <option value="chinese_makin">Chinese â€“ Makin</option>
      <option value="uyghur_saleh">Uyghur â€“ Saleh</option>
      <option value="japanese_saeedsato">Japanese â€“ Saeed Sato</option>
      <option value="vietnamese_rwwad">Vietnamese â€“ RWWAD</option>
      <option value="khmer_rwwad">Khmer â€“ RWWAD</option>
      <option value="persian_ih">Persian â€“ IH</option>
      <option value="kurdish_bamoki">Kurdish â€“ Bamoki</option>
      <option value="pashto_rwwad">Pashto â€“ RWWAD</option>
      <option value="urdu_junagarhi">Urdu â€“ Junagarhi</option>
      <option value="hindi_omari">Hindi â€“ Omari</option>
      <option value="telugu_muhammad">Telugu â€“ Muhammad</option>
      <option value="gujarati_omari">Gujarati â€“ Omari</option>
      <option value="malayalam_kunhi">Malayalam â€“ Kunhi</option>
      <option value="kannada_hamza">Kannada â€“ Hamza</option>
      <option value="assamese_rafeeq">Assamese â€“ Rafeeq</option>
      <option value="punjabi_arif">Punjabi â€“ Arif</option>
      <option value="tamil_omar">Tamil â€“ Omar</option>
      <option value="tamil_baqavi">Tamil â€“ Baqavi</option>
      <option value="sinhalese_mahir">Sinhalese â€“ Mahir</option>
      <option value="swahili_barawani">Swahili â€“ Barawani</option>
      <option value="somali_yacob">Somali â€“ Yacob</option>
      <option value="amharic_zain">Amharic â€“ Zain</option>
      <option value="yoruba_mikail">Yoruba â€“ Mikail</option>
      <option value="hausa_gummi">Hausa â€“ Gummi</option>
      <option value="oromo_ababor">Oromo â€“ Ababor</option>
      <option value="afar_hamza">Afar â€“ Hamza</option>
      <option value="ankobambara_dayyan">Ankobambara â€“ Dayyan</option>
      <option value="kinyarwanda_assoc">Kinyarwanda â€“ Assoc</option>
      <option value="ikirundi_gehiti">Kirundi â€“ Gehiti</option>
      <option value="moore_rwwad">Moore â€“ RWWAD</option>
      <option value="asante_harun">Asante â€“ Harun</option>
      <option value="lingala_zakaria">Lingala â€“ Zakaria</option>
    </select>
  </label>
  <label>Terjemah Per Kata
    <select id="wordTranslationSelect">
    <option value="33">Indonesian â€“ Islamic Affairs Ministry</option>
    <option value="19">English â€“ M. Pickthall</option>
    <option value="20">English â€“ Saheeh International</option>
    <option value="22">English â€“ A. Yusuf Ali</option>
    <option value="23">Azeri â€“ Azerbaijani</option>
    <option value="25">Bosnian â€“ Muhamed MehanoviÄ‡</option>
    <option value="26">Czech â€“ Czech</option>
    <option value="27">German â€“ Frank Bubenheim and Nadeem</option>
    <option value="29">Persian â€“ Hussein Taji Kal Dari</option>
    <option value="30">Finnish â€“ Finnish</option>
    <option value="31">French â€“ Muhammad Hamidullah</option>
    <option value="32">Hausa â€“ Abubakar Gumi</option>
    <option value="35">Japanese â€“ Ryoichi Mita</option>
    <option value="36">Korean â€“ Korean</option>
    <option value="37">Malayalam â€“ Abdul Hameed and Kunhi</option>
    <option value="38">Maranao â€“ Maranao</option>
    <option value="39">Malay â€“ Abdullah Muhammad Basmeih</option>
    <option value="41">Norwegian â€“ Norwegian</option>
    <option value="42">Polish â€“ JÃ³zef Bielawski</option>
    <option value="43">Portuguese â€“ Samir</option>
    <option value="44">Romanian â€“ Grigore</option>
    <option value="45">Russian â€“ Elmir Kuliev</option>
    <option value="46">Somali â€“ Mahmud Muhammad Abduh</option>
    <option value="47">Albanian â€“ Albanian</option>
    <option value="48">Swedish â€“ Knut BernstrÃ¶m</option>
    <option value="49">Swahili â€“ Ali Muhsin Al-Barwani</option>
    <option value="50">Tamil â€“ Jan Trust Foundation</option>
    <option value="51">Thai â€“ King Fahad Quran Complex</option>
    <option value="52">Turkish â€“ Elmalili Hamdi Yazir</option>
    <option value="53">Tatar â€“ Tatar</option>
    <option value="54">Urdu â€“ Maulana Muhammad Junagarhi</option>
    <option value="55">Uzbek â€“ Muhammad Sodiq Muhammad Yusuf (Latin)</option>
    <option value="56">Chinese â€“ Ma Jain</option>
    <option value="57">English â€“ Transliteration</option>
    <option value="74">Tajik â€“ Tajik</option>
    <option value="75">Azeri â€“ Alikhan Musayev</option>
    <option value="76">Uyghur â€“ Muhammad Saleh</option>
    <option value="77">Turkish â€“ Diyanet</option>
    <option value="78">Russian â€“ Ministry of Awqaf, Egypt</option>
    <option value="79">Russian â€“ Abu Adel</option>
    <option value="80">Malayalam â€“ Muhammad Karakunnu & Vanidas Elayavoor</option>
    <option value="81">Kurdish â€“ Burhan Muhammad-Amin</option>
    <option value="83">Spanish â€“ Sheikh Isa Garcia</option>
    <option value="84">English â€“ T. Usmani</option>
    <option value="85">English â€“ M.A.S. Abdel Haleem</option>
    <option value="86">Divehi â€“ Office of the President of Maldives</option>
    <option value="87">Amharic â€“ Sadiq and Sani</option>
    <option value="88">Albanian â€“ Hasan Efendi Nahi</option>
    <option value="89">Albanian â€“ Albanian Translation</option>
    <option value="95">English â€“ A. Maududi (Tafhim)</option>
    <option value="97">Urdu â€“ Tafheem e Qur'an â€“ Syed Abu Ali Maududi</option>
    </select>
  </label>
</div>

<div class="version-buttons">
  <button onclick="setVersion('v2')">ğŸ“œ Gunakan Quran V2</button>
  <button onclick="setVersion('v1')">ğŸ“„ Gunakan Quran V1</button>
</div>

<div id="pages"></div>

<script>
const surahList = { 1:["Al-FÄtiá¸¥ah"], 2:["Al-Baqarah"], ... /* disingkat */ };

const surahSelect = document.getElementById("surahSelect");
const ayahSelect = document.getElementById("ayahSelect");
const wordCount = document.getElementById("wordCount");
const translationSelect = document.getElementById("translationSelect");
const wordTranslationId = document.getElementById("wordTranslationId");
let currentVersion = 'v1';

function setVersion(v) {
  currentVersion = v;
  loadAyat();
}

for (let i = 1; i <= 114; i++) {
  const [name] = surahList[i];
  surahSelect.appendChild(new Option(`${i}. ${name}`, i));
}

surahSelect.addEventListener("change", updateAyahDropdown);
ayahSelect.addEventListener("change", loadAyat);
wordCount.addEventListener("change", loadAyat);
translationSelect.addEventListener("change", loadAyat);
wordTranslationId.addEventListener("change", loadAyat);

async function updateAyahDropdown() {
  const s = surahSelect.value;
  const res = await fetch(`https://api.quran.com/api/v4/chapters/${s}`);
  const json = await res.json();
  const max = json.chapter.verses_count;
  ayahSelect.innerHTML = "";
  for (let i = 1; i <= max; i++) {
    ayahSelect.appendChild(new Option(`Ayat ${i}`, i));
  }
  ayahSelect.value = 1;
  loadAyat();
}

async function loadAyat() {
  const s = surahSelect.value;
  const a = ayahSelect.value;
  const wc = +wordCount.value;
  const key = `${s}:${a}`;
  const container = document.getElementById("pages");
  container.innerHTML = "";

  const pageMap = await fetch("https://raw.githubusercontent.com/dickymiswardi/tadabbur/main/ayah_page_map.json").then(r => r.json());
  const page = pageMap[key];
  const fontName = currentVersion === 'v1'
    ? `QCF_P${String(page).padStart(3, '0')}`
    : `QCF2${String(page).padStart(3, '0')}`;
  const fontUrl = currentVersion === "v1"
    ? `https://cdn.jsdelivr.net/gh/dickymiswardi/quran/fonts/${fontName}.TTF`
    : `https://cdn.jsdelivr.net/gh/tafsirnetlifyapp/quran@refs/heads/main/fontsglyphvs/${fontName}.ttf`;

  const apiField = currentVersion === "v1" ? "code_v1" : "code_v2";
  const data = await fetch(`https://api.quran.com/api/v4/verses/by_key/${key}?words=true&word_fields=${apiField}`).then(r => r.json());
  const words = data.verse.words.map(w => ({
    arabic: w[apiField] || w.text,
    id: w.id
  }));

  // update dropdown jumlah kata
  wordCount.innerHTML = "";
  wordCount.appendChild(new Option("Semua", 0));
  for (let i = 1; i <= words.length; i++) {
    wordCount.appendChild(new Option(i, i));
  }
  wordCount.value = wc <= words.length ? wc : 0;

  const style = document.createElement("style");
  style.textContent = `@font-face {
    font-family: '${fontName}';
    src: url('${fontUrl}') format('truetype');
  }`;
  document.head.appendChild(style);

  const div = document.createElement("div");
  div.className = "page-container";
  div.style.fontFamily = fontName;
  container.appendChild(div);

  await document.fonts.load(`1em ${fontName}`);
  const line = document.createElement("div");

  const wordTransId = wordTranslationId.value;
  let wordTranslations = [];
  if (wordTransId !== "0") {
    try {
      const r = await fetch(`https://api.quran.com/api/v4/verses/by_key/${key}?words=true&language=id&translations=${wordTransId}`);
      const j = await r.json();
      wordTranslations = j.verse.words.map(w => w.translation?.text || "");
    } catch (e) {
      console.error("Gagal ambil terjemah perkata:", e);
    }
  }

  words.slice(0, wc || undefined).forEach((word, i) => {
    const span = document.createElement("span");
    span.className = "word";
    span.innerText = word.arabic;

    if (wordTransId !== "0" && wordTranslations[i]) {
      const sub = document.createElement("span");
      sub.className = "word-translation";
      sub.innerText = wordTranslations[i];
      span.appendChild(sub);
    }
    line.appendChild(span);
    line.appendChild(document.createTextNode(" "));
  });

  div.appendChild(line);

  // Tampilkan terjemahan biasa
  const tkey = translationSelect.value;
  if (tkey) {
    try {
      const r = await fetch(`https://quranenc.com/api/v1/translation/aya/${tkey}/${s}/${a}`);
      const jt = await r.json();
      if (jt.result && jt.result.translation) {
        const transDiv = document.createElement("div");
        transDiv.className = "translation";
        transDiv.textContent = jt.result.translation;
        div.appendChild(transDiv);
      }
    } catch (e) {
      console.error("Gagal ambil terjemahan:", e);
    }
  }

  div.style.display = "block";
  requestAnimationFrame(() => div.style.opacity = "1");
}

surahSelect.value = 1;
updateAyahDropdown();
</script>

</body>
</html>

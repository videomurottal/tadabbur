<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Mushaf Dinamis V1/V2 + Terjemah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      background: #fefcf8;
      padding: 1em;
      font-family: sans-serif;
      direction: rtl;
      margin: 0;
    }
    h2 {
      text-align: center;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      margin-bottom: 1rem;
    }
    .controls {
      direction: ltr;
      max-width: 800px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.8em;
      justify-content: center;
      align-items: center;
      padding: 0.5em;
    }
    .controls label {
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      display: flex;
      flex-direction: column;
    }
    select, button {
      font-size: clamp(1rem, 3vw, 1.2rem);
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4cafef;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background-color: #007acc;
    }
    .version-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.8em;
      margin-top: 1em;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .version-buttons button {
      padding: 0.8em;
      border-radius: 8px;
      background-color: #4cafef;
      color: #fff;
      border: none;
      font-size: clamp(1rem, 2.5vw, 1.1rem);
      cursor: pointer;
    }
    .version-buttons button:hover {
      background-color: #007acc;
    }
    .page-container {
      font-size: clamp(1.8em, 5vw, 2.5em);
      line-height: 1.8;
      text-align: center;
      user-select: text;
      margin: 2em auto;
      opacity: 0;
      transition: opacity 0.3s ease;
      display: none;
      word-spacing: -0.08em;
      max-width: 95%;
      overflow-wrap: break-word;
    }
    .word {
      display: inline-block;
      margin: 0;
      cursor: default;
    }
    .translation {
      font-family: sans-serif;
      font-size: clamp(1rem, 3vw, 1.2rem);
      color: #333;
      direction: ltr;
      text-align: center;
      margin-top: 1em;
      padding: 0 0.5em;
    }
    @media (max-width: 600px) {
      .controls, .version-buttons {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>

<h2>üìñ Al-Qur'an Dinamis (V1/V2 + Terjemah)</h2>

<div class="controls">
  <!-- Baris 1: Surah & Ayat -->
  <label>Surah
    <select id="surahSelect"></select>
  </label>
  <label>Ayat
    <select id="ayahSelect"></select>
  </label>

  <!-- Baris 2: Dari Kata & Sampai Kata -->
  <label>Dari Kata
    <select id="wordStart"></select>
  </label>
  <label>Sampai Kata
    <select id="wordEnd"></select>
  </label>

  <!-- Baris 3: Terjemahan & Tombol Link -->
  <label>Terjemahan
    <select id="wordTranslationId">
      <option value="33" selected>Indonesian ‚Äì Islamic Affairs Ministry</option>
      <option value="20">English ‚Äì Saheeh International</option>
    </select>
  </label>
  <label>&nbsp;
    <button id="customLinkButton">üîó Tombol Link</button>
  </label>
</div>

<!-- Baris 4: Tombol Gunakan Quran V1/V2 -->
<div class="version-buttons">
  <button onclick="setVersion('v2')">üìú Gunakan Quran V2</button>
  <button onclick="setVersion('v1')">üìÑ Gunakan Quran V1</button>
</div>

<div id="pages"></div>

<!-- üîé Modal Search Ayat -->
<div id="searchModal" style="
  display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div style="
    background:white; padding:1em; max-width:600px; width:90%;
    border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
    <h3 style="margin-top:0;">üîç Cari Ayat</h3>
    <input id="searchInput" placeholder="Ketik kata Arab/ID/EN..." style="width:100%;padding:0.5em; margin-bottom:0.5em;"/>
    <div id="searchResults" style="max-height:300px; overflow-y:auto;"></div>
    <button onclick="closeSearch()" style="margin-top:0.5em; padding:0.5em 1em; background:#f44336; color:white; border:none; border-radius:4px;">‚ùå Tutup</button>
  </div>
</div>

<!-- üî• Loader Overlay -->
<div id="loaderOverlay" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  display: none;">
  <div style="
    border: 8px solid #f3f3f3;
    border-top: 8px solid #4cafef;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;">
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>

function saveHistory() {
  const history = {
    surah: surahSelect.value,
    ayah: ayahSelect.value,
    wordStart: wordStart.value,
    wordEnd: wordEnd.value,
    translation: wordTranslationId.value,
    version: currentVersion
  };
  localStorage.setItem('quranHistory', JSON.stringify(history));
}

function loadHistory() {
  const history = JSON.parse(localStorage.getItem('quranHistory') || '{}');
  if (history.surah) surahSelect.value = history.surah;
  if (history.version) currentVersion = history.version;
  return history;
}

const loaderOverlay = document.getElementById('loaderOverlay');

function showLoader() {
  loaderOverlay.style.display = 'flex';
}
function hideLoader() {
  loaderOverlay.style.display = 'none';
}
  
const translationLanguageMap = {
  "20": "en", "33": "id"
};

  const surahList = {
  1:["Al-FƒÅti·∏•ah"], 2:["Al-Baqarah"], 3:["ƒÄl  øImrƒÅn"], 4:["An-NisƒÅ æ"],
  5:["Al-MƒÅ æidah"], 6:["Al-An øƒÅm"], 7:["Al-A ørƒÅf"], 8:["Al-AnfƒÅl"],
  9:["At-Tawbah"], 10:["Y≈´nus"], 11:["H≈´d"], 12:["Y≈´suf"], 13:["Ar-Ra ød"],
  14:["IbrƒÅhƒ´m"], 15:["Al-·∏§ijr"], 16:["An-Na·∏•l"], 17:["Al-IsrƒÅ æ"],
  18:["Al-Kahf"], 19:["Maryam"], 20:["·π¨ƒÅ-HƒÅ"], 21:["Al-AnbiyƒÅ æ"],
  22:["Al-·∏§ajj"], 23:["Al-Mu æmin≈´n"], 24:["An-N≈´r"], 25:["Al-FurqƒÅn"],
  26:["Ash-Shu øarƒÅ æ"], 27:["An-Naml"], 28:["Al-Qa·π£a·π£"], 29:["Al- øAnkab≈´t"],
  30:["Ar-R≈´m"], 31:["LuqmƒÅn"], 32:["As-Sajdah"], 33:["Al-A·∏•zƒÅb"],
  34:["Saba æ"], 35:["FƒÅ·π≠ir"], 36:["YƒÅ-Sƒ´n"], 37:["As-·π¢ƒÅffƒÅt"],
  38:["·π¢ƒÅd"], 39:["Az-Zumar"], 40:["GhƒÅfir"], 41:["Fu·π£·π£ilat"], 42:["Ash-Sh≈´rƒÅ"],
  43:["Az-Zukhruf"], 44:["Ad-DukhƒÅn"], 45:["Al-JƒÅthiyah"], 46:["Al-A·∏•qƒÅf"],
  47:["Mu·∏•ammad"], 48:["Al-Fat·∏•"], 49:["Al-·∏§ujurƒÅt"], 50:["QƒÅf"],
  51:["Adh-DhƒÅriyƒÅt"], 52:["A·π≠-·π¨≈´r"], 53:["An-Najm"], 54:["Al-Qamar"],
  55:["Ar-Ra·∏•mƒÅn"], 56:["Al-WƒÅqi øah"], 57:["Al-·∏§adƒ´d"], 58:["Al-MujƒÅdilah"],
  59:["Al-·∏§ashr"], 60:["Al-Mumta·∏•anah"], 61:["A·π£-·π¢aff"], 62:["Al-Jumu øah"],
  63:["Al-MunƒÅfiq≈´n"], 64:["At-TaghƒÅbun"], 65:["A·π≠-·π¨alƒÅq"], 66:["At-Ta·∏•rƒ´m"],
  67:["Al-Mulk"], 68:["Al-Qalam"], 69:["Al-·∏§ƒÅqqah"], 70:["Al-Ma øƒÅrij"],
  71:["N≈´·∏•"], 72:["Al-Jinn"], 73:["Al-Muzzammil"], 74:["Al-Muddaththir"],
  75:["Al-QiyƒÅmah"], 76:["Al-InsƒÅn"], 77:["Al-MursalƒÅt"], 78:["An-Naba æ"],
  79:["An-NƒÅzi øƒÅt"], 80:[" øAbasa"], 81:["At-Takwƒ´r"], 82:["Al-Infi·π≠ƒÅr"],
  83:["Al-Mu·π≠affifƒ´n"], 84:["Al-InshiqƒÅq"], 85:["Al-Bur≈´j"], 86:["A·π≠-·π¨ƒÅriq"],
  87:["Al-A ølƒÅ"], 88:["Al-GhƒÅshiyah"], 89:["Al-Fajr"], 90:["Al-Balad"],
  91:["Ash-Shams"], 92:["Al-Layl"], 93:["A·∏ç-·∏åu·∏•ƒÅ"], 94:["Ash-Shar·∏•"],
  95:["At-Tƒ´n"], 96:["Al- øAlaq"], 97:["Al-Qadr"], 98:["Al-Bayyinah"],
  99:["Az-Zalzalah"], 100:["Al- øƒÄdiyƒÅt"], 101:["Al-QƒÅri øah"], 102:["At-TakƒÅthur"],
  103:["Al- øA·π£r"], 104:["Al-Humazah"], 105:["Al-Fƒ´l"], 106:["Quraysh"],
  107:["Al-MƒÅ ø≈´n"], 108:["Al-Kawthar"], 109:["Al-KƒÅfir≈´n"], 110:["An-Na·π£r"],
  111:["Al-Masad"], 112:["Al-IkhlƒÅ·π£"], 113:["Al-Falaq"], 114:["An-NƒÅs"]
};

const surahSelect = document.getElementById("surahSelect");
const ayahSelect = document.getElementById("ayahSelect");
const wordStart = document.getElementById("wordStart");
const wordEnd = document.getElementById("wordEnd");
const wordTranslationId = document.getElementById("wordTranslationId");
let currentVersion = 'v1';
let words = []; // Global
let initialLoad = true;

function setVersion(v) {
  currentVersion = v;
  loadAyat();
}

for (let i in surahList) {
  const [name] = surahList[i];
  surahSelect.appendChild(new Option(`${i}. ${name}`, i));
}

surahSelect.addEventListener("change", () => {
  updateAyahDropdown();
  saveHistory();
});
ayahSelect.addEventListener("change", () => {
  loadAyat();
  saveHistory();
});

wordStart.addEventListener("change", () => {
  const startVal = +wordStart.value;
  wordEnd.innerHTML = "";
  for (let i = startVal; i <= words.length; i++) {
    wordEnd.appendChild(new Option(i, i));
  }
  wordEnd.value = startVal;
  loadAyat();
  saveHistory(); // ‚úÖ Simpan histori setiap ganti
});

wordEnd.addEventListener("change", () => {
  loadAyat();
  saveHistory(); // ‚úÖ Simpan histori setiap ganti
});

wordTranslationId.addEventListener("change", () => {
  loadAyat();
  saveHistory(); // ‚úÖ Simpan histori setiap ganti
});

async function updateAyahDropdown() {
  const s = surahSelect.value;
  const res = await fetch(`https://api.quran.com/api/v4/chapters/${s}`);
  const json = await res.json();
  const max = json.chapter.verses_count;
  ayahSelect.innerHTML = "";
  for (let i = 1; i <= max; i++) {
    ayahSelect.appendChild(new Option(`Ayat ${i}`, i));
  }
  ayahSelect.value = 1;
  loadAyat();
}

async function loadAyat() {
  showLoader(); // üî• Munculkan loader
  try {
    const s = surahSelect.value;
    const a = ayahSelect.value;
    const key = `${s}:${a}`;
    const container = document.getElementById("pages");
    container.innerHTML = "";

    const pageMap = await fetch("https://raw.githubusercontent.com/dickymiswardi/tadabbur/main/ayah_page_map.json").then(r => r.json());
    const page = pageMap[key];
    const fontName = currentVersion === 'v1' ? `QCF_P${String(page).padStart(3, '0')}` : `QCF2${String(page).padStart(3, '0')}`;
    const fontUrl = currentVersion === "v1"
      ? `https://cdn.jsdelivr.net/gh/dickymiswardi/quran/fonts/${fontName}.TTF`
      : `https://cdn.jsdelivr.net/gh/tafsirnetlifyapp/quran@refs/heads/main/fontsglyphvs/${fontName}.ttf`;

    const apiField = currentVersion === "v1" ? "code_v1" : "code_v2";
    const data = await fetch(`https://api.quran.com/api/v4/verses/by_key/${key}?words=true&word_fields=${apiField}`).then(r => r.json());
    words = data.verse.words.map(w => ({ arabic: w[apiField] || w.text, id: w.id }));

    const prevStart = +wordStart.value || 1;
    const prevEnd = +wordEnd.value || 1;

    wordStart.innerHTML = "";
    for (let i = 1; i <= words.length; i++) {
      let option = new Option(`Word ${i}`, i);
      wordStart.appendChild(option);
    }
    wordStart.value = initialLoad ? 1 : Math.min(prevStart, words.length);

    wordEnd.innerHTML = "";
    for (let i = wordStart.value; i <= words.length; i++) {
      let option = new Option(`To ${i}`, i);
      wordEnd.appendChild(option);
    }
    wordEnd.value = initialLoad ? 1 : Math.min(prevEnd, words.length);

    initialLoad = false;

    const style = document.createElement("style");
    style.textContent = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}') format('truetype'); }`;
    document.head.appendChild(style);

    const div = document.createElement("div");
    div.className = "page-container";
    div.style.fontFamily = fontName;
    container.appendChild(div);

    await document.fonts.load(`1em ${fontName}`);

    const startIdx = (+wordStart.value || 1) - 1;
    const endIdx = (+wordEnd.value || startIdx + 1);

    const line = document.createElement("div");
    words.slice(startIdx, endIdx).forEach(word => {
      const span = document.createElement("span");
      span.className = "word";
      span.innerText = word.arabic;
      line.appendChild(span);
      line.appendChild(document.createTextNode(" "));
    });
    div.appendChild(line);

    if (wordTranslationId.value) {
      const langCode = translationLanguageMap[wordTranslationId.value];
      try {
        const r = await fetch(`https://api.quran.com/api/v4/verses/by_key/${key}?words=true&language=${langCode}&translations=${wordTranslationId.value}`);
        const j = await r.json();
        const wordsData = j.verse.words;
        const wordTranslations = wordsData.map(w => w.translation?.text || "").slice(startIdx, endIdx);

        const perKataDiv = document.createElement("div");
        perKataDiv.className = "translation";
        perKataDiv.textContent = wordTranslations.join(" ");
        div.appendChild(perKataDiv);
      } catch (e) {
        console.error("Gagal ambil terjemah perkata:", e);
      }
    }

    div.style.display = "block";
    requestAnimationFrame(() => div.style.opacity = "1");
  } catch (e) {
    alert("Gagal memuat ayat: " + e.message);
  } finally {
    hideLoader(); // üî• Hilangkan loader
  }
}

const last = loadHistory();
updateAyahDropdown().then(() => {
  if (last.ayah) ayahSelect.value = last.ayah;
  if (last.wordStart) wordStart.value = last.wordStart;
  if (last.wordEnd) wordEnd.value = last.wordEnd;
  if (last.translation) wordTranslationId.value = last.translation;
  // üü¢ Tidak perlu panggil loadAyat() lagi di sini karena sudah dipanggil di updateAyahDropdown()
});
</script>

<script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval.iife.min.js"></script>
<script>
    async function cacheXMLFiles() {
  const files = {
    arab: "https://raw.githubusercontent.com/tafsirnetlifyapp/quran/refs/heads/main/quran.xml",
    id: "https://raw.githubusercontent.com/tafsirnetlifyapp/quran/refs/heads/main/TerjemahID.xml",
    en: "https://raw.githubusercontent.com/tafsirnetlifyapp/quran/refs/heads/main/terjemahEN.xml"
  };

  for (const [key, url] of Object.entries(files)) {
    if (!await idbKeyval.get(key)) {
      console.log(`‚¨áÔ∏è Downloading ${key}...`);
      const res = await fetch(url);
      const text = await res.text();
      await idbKeyval.set(key, text);
      console.log(`‚úÖ ${key} saved to IndexedDB`);
    } else {
      console.log(`‚ö° ${key} already cached`);
    }
  }
}

cacheXMLFiles();

    async function searchAyat(query) {
  const arabXML = await idbKeyval.get('arab');
  const idXML = await idbKeyval.get('id');
  const enXML = await idbKeyval.get('en');

  const parser = new DOMParser();
  const arabDoc = parser.parseFromString(arabXML, "text/xml");
  const idDoc = parser.parseFromString(idXML, "text/xml");
  const enDoc = parser.parseFromString(enXML, "text/xml");

  const results = [];

  arabDoc.querySelectorAll('aya').forEach(aya => {
    const arabText = aya.getAttribute('text');
    const surahIndex = aya.parentNode.getAttribute('index');
    const ayahIndex = aya.getAttribute('index');

    const idVerse = idDoc.querySelector(`Chapter[ChapterID="${surahIndex}"] Verse[VerseID="${ayahIndex}"]`);
    const enVerse = enDoc.querySelector(`Chapter[ChapterID="${surahIndex}"] Verse[VerseID="${ayahIndex}"]`);

    const idText = idVerse ? idVerse.textContent : '';
    const enText = enVerse ? enVerse.textContent : '';

    if (arabText.includes(query) || idText.toLowerCase().includes(query.toLowerCase()) || enText.toLowerCase().includes(query.toLowerCase())) {
      results.push({
        surah: surahIndex,
        ayah: ayahIndex,
        arab: arabText,
        id: idText,
        en: enText
      });
    }
  });

  return results;
}

searchInput.addEventListener('input', async () => {
  const q = searchInput.value.trim();
  searchResults.innerHTML = q ? "üîç Searching..." : "";
  if (!q) return;

  const found = await searchAyat(q);
  if (found.length === 0) {
    searchResults.innerHTML = "‚ùå Tidak ditemukan.";
    return;
  }

  searchResults.innerHTML = found.map(r => `
    <div style="margin-bottom:1em; padding:0.5em; border-bottom:1px solid #ddd;">
      <b>üìñ Surah ${r.surah}:${r.ayah}</b><br>
      <div dir="rtl" style="font-size:1.5em; margin:0.5em 0;">${r.arab}</div>
      <div><i>${r.id}</i></div>
      <div><i>${r.en}</i></div>
      <button onclick="gotoAyat(${r.surah}, ${r.ayah})" style="margin-top:0.5em; padding:0.3em 0.6em; background:#4cafef; color:white; border:none; border-radius:4px;">üìñ Buka Ayat Ini</button>
    </div>
  `).join('');
});

  document.getElementById('customLinkButton').addEventListener('click', () => {
  document.getElementById('searchModal').style.display = 'flex';
});

function closeSearch() {
  document.getElementById('searchModal').style.display = 'none';
}

  function gotoAyat(surah, ayah) {
  surahSelect.value = surah;
  ayahSelect.value = ayah;
  loadAyat();
  closeSearch();
}
  </script>
  
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Mushaf Dinamis V1/V2 + Terjemah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #fefcf8;
      padding: 1em;
      font-family: sans-serif;
      direction: rtl;
    }
    h2 { text-align: center; }
    .controls {
      direction: ltr;
      max-width: 720px;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
      align-items: flex-end;
    }
    label { font-size: 0.9em; }
    select, button {
      font-size: 1em;
      padding: 0.5em;
    }
    .version-buttons {
      margin-top: 1em;
      text-align: center;
    }
    .page-container {
      font-size: 2.5em;
      line-height: 1.6;
      text-align: center;
      user-select: text;
      margin: 2em auto;
      opacity: 0;
      transition: opacity 0.3s ease;
      display: none;
      word-spacing: -0.08em;
      max-width: 700px;
    }
    .word {
      display: inline-block;
      margin: 0;
      cursor: default;
    }
    .translation {
      font-family: sans-serif;
      font-size: 1em;
      color: #333;
      direction: ltr;
      text-align: center;
      margin-top: 1em;
    }
    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #popupContent {
      background: #fff;
      padding: 1.5em;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      text-align: left;
      direction: ltr;
    }
    #popupContent h3 {
      margin-top: 0;
    }
    #closePopup {
      background: #f44336;
      color: #fff;
      border: none;
      padding: 0.5em 1em;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 1em;
    }
  </style>
</head>
<body>

<h2>ğŸ“– Al-Qur'an Dinamis (V1/V2 + Terjemah)</h2>

<div class="controls">
  <label><select id="surahSelect"></select>
  </label>
  <label><select id="ayahSelect"></select>
  </label>
  <label><select id="wordStart"></select>
  </label>
  <label><select id="wordEnd"></select>
  </label>
  <label><select id="wordTranslationId">
      <option value="33">Indonesian â€“ Islamic Affairs Ministry</option>
      <option value="20">English â€“ Saheeh International</option>
    </select>
  </label>
  <button onclick="showPopup()">ğŸ“– Pembanding</button>
</div>

<div class="version-buttons">
  <button onclick="setVersion('v1')">ğŸ“„ Gunakan Quran V1</button>
  <button onclick="setVersion('v2')">ğŸ“œ Gunakan Quran V2</button>
</div>

<div id="pages"></div>

<!-- Popup -->
<div id="popup">
  <div id="popupContent">
    <h3>Terjemah Lengkap</h3>
    <p id="popupText">Loading...</p>
    <button id="closePopup" onclick="closePopup()">Tutup</button>
  </div>
</div>

<script>
const surahList = {
  1:["Al-FÄtiá¸¥ah"], 2:["Al-Baqarah"], 3:["Ä€l Ê¿ImrÄn"], 4:["An-NisÄÊ¾"],
  5:["Al-MÄÊ¾idah"], 6:["Al-AnÊ¿Äm"], 7:["Al-AÊ¿rÄf"], 8:["Al-AnfÄl"],
  9:["At-Tawbah"], 10:["YÅ«nus"], 11:["HÅ«d"], 12:["YÅ«suf"], 13:["Ar-RaÊ¿d"],
  14:["IbrÄhÄ«m"], 15:["Al-á¸¤ijr"], 16:["An-Naá¸¥l"], 17:["Al-IsrÄÊ¾"],
  18:["Al-Kahf"], 19:["Maryam"], 20:["á¹¬Ä-HÄ"], 21:["Al-AnbiyÄÊ¾"],
  22:["Al-á¸¤ajj"], 23:["Al-MuÊ¾minÅ«n"], 24:["An-NÅ«r"], 25:["Al-FurqÄn"],
  26:["Ash-ShuÊ¿arÄÊ¾"], 27:["An-Naml"], 28:["Al-Qaá¹£aá¹£"], 29:["Al-Ê¿AnkabÅ«t"],
  30:["Ar-RÅ«m"], 31:["LuqmÄn"], 32:["As-Sajdah"], 33:["Al-Aá¸¥zÄb"],
  34:["SabaÊ¾"], 35:["FÄá¹­ir"], 36:["YÄ-SÄ«n"], 37:["As-á¹¢ÄffÄt"],
  38:["á¹¢Äd"], 39:["Az-Zumar"], 40:["GhÄfir"], 41:["Fuá¹£á¹£ilat"], 42:["Ash-ShÅ«rÄ"],
  43:["Az-Zukhruf"], 44:["Ad-DukhÄn"], 45:["Al-JÄthiyah"], 46:["Al-Aá¸¥qÄf"],
  47:["Muá¸¥ammad"], 48:["Al-Fatá¸¥"], 49:["Al-á¸¤ujurÄt"], 50:["QÄf"],
  51:["Adh-DhÄriyÄt"], 52:["Aá¹­-á¹¬Å«r"], 53:["An-Najm"], 54:["Al-Qamar"],
  55:["Ar-Raá¸¥mÄn"], 56:["Al-WÄqiÊ¿ah"], 57:["Al-á¸¤adÄ«d"], 58:["Al-MujÄdilah"],
  59:["Al-á¸¤ashr"], 60:["Al-Mumtaá¸¥anah"], 61:["Aá¹£-á¹¢aff"], 62:["Al-JumuÊ¿ah"],
  63:["Al-MunÄfiqÅ«n"], 64:["At-TaghÄbun"], 65:["Aá¹­-á¹¬alÄq"], 66:["At-Taá¸¥rÄ«m"],
  67:["Al-Mulk"], 68:["Al-Qalam"], 69:["Al-á¸¤Äqqah"], 70:["Al-MaÊ¿Ärij"],
  71:["NÅ«á¸¥"], 72:["Al-Jinn"], 73:["Al-Muzzammil"], 74:["Al-Muddaththir"],
  75:["Al-QiyÄmah"], 76:["Al-InsÄn"], 77:["Al-MursalÄt"], 78:["An-NabaÊ¾"],
  79:["An-NÄziÊ¿Ät"], 80:["Ê¿Abasa"], 81:["At-TakwÄ«r"], 82:["Al-Infiá¹­Är"],
  83:["Al-Muá¹­affifÄ«n"], 84:["Al-InshiqÄq"], 85:["Al-BurÅ«j"], 86:["Aá¹­-á¹¬Äriq"],
  87:["Al-AÊ¿lÄ"], 88:["Al-GhÄshiyah"], 89:["Al-Fajr"], 90:["Al-Balad"],
  91:["Ash-Shams"], 92:["Al-Layl"], 93:["Aá¸-á¸Œuá¸¥Ä"], 94:["Ash-Shará¸¥"],
  95:["At-TÄ«n"], 96:["Al-Ê¿Alaq"], 97:["Al-Qadr"], 98:["Al-Bayyinah"],
  99:["Az-Zalzalah"], 100:["Al-Ê¿Ä€diyÄt"], 101:["Al-QÄriÊ¿ah"], 102:["At-TakÄthur"],
  103:["Al-Ê¿Aá¹£r"], 104:["Al-Humazah"], 105:["Al-FÄ«l"], 106:["Quraysh"],
  107:["Al-MÄÊ¿Å«n"], 108:["Al-Kawthar"], 109:["Al-KÄfirÅ«n"], 110:["An-Naá¹£r"],
  111:["Al-Masad"], 112:["Al-IkhlÄá¹£"], 113:["Al-Falaq"], 114:["An-NÄs"]
};


const surahSelect = document.getElementById("surahSelect");
const ayahSelect = document.getElementById("ayahSelect");
const wordStart = document.getElementById("wordStart");
const wordEnd = document.getElementById("wordEnd");
const wordTranslationId = document.getElementById("wordTranslationId");
let currentVersion = 'v1';
  
// Isi dropdown Surah
for (let i in surahList) {
  const [name] = surahList[i];
  surahSelect.appendChild(new Option(`${i}. ${name}`, i));
}

// Set default
surahSelect.value = 1;
wordTranslationId.value = 33; // Default Indonesia ID 33

async function updateAyahDropdown() {
  const s = surahSelect.value;
  const res = await fetch(`https://api.quran.com/api/v4/chapters/${s}`);
  const json = await res.json();
  const max = json.chapter.verses_count;
  ayahSelect.innerHTML = "";
  for (let i = 1; i <= max; i++) {
    ayahSelect.appendChild(new Option(`Ayat ${i}`, i));
  }
  ayahSelect.value = 1; // Default Ayat 1
  await loadAyat();
}

function syncWordEnd() {
  const start = parseInt(wordStart.value);
  wordEnd.innerHTML = "";
  for (let i = start; i <= wordEnd.dataset.max; i++) {
    wordEnd.appendChild(new Option(i, i));
  }
  wordEnd.value = start;
  loadAyat();
}

  wordStart.addEventListener("change", () => {
  updateWordEndOptions();
  loadAyat();
});
wordEnd.addEventListener("change", loadAyat);


// Isi wordStart & wordEnd
wordStart.innerHTML = "";
for (let i = 1; i <= words.length; i++) {
  wordStart.appendChild(new Option(`Word ${i}`, i));
}
wordStart.value = 1;

updateWordEndOptions();

function updateWordEndOptions() {
  const start = parseInt(wordStart.value);
  wordEnd.innerHTML = "";
  for (let i = start; i <= words.length; i++) {
    wordEnd.appendChild(new Option(`To ${i}`, i));
  }
  if (parseInt(wordEnd.value) < start) {
    wordEnd.value = start;
  }
  if (!wordEnd.value) {
    wordEnd.value = start < words.length ? start + 1 : start;
  }
}


async function loadAyat() {
  const s = surahSelect.value;
  const a = ayahSelect.value;
  const ws = parseInt(wordStart.value);
  const we = parseInt(wordEnd.value);
  const key = `${s}:${a}`;
  const container = document.getElementById("pages");
  container.innerHTML = "";

  const pageMap = await fetch("https://raw.githubusercontent.com/dickymiswardi/tadabbur/main/ayah_page_map.json").then(r => r.json());
  const page = pageMap[key];
  const fontName = currentVersion === 'v1' ? `QCF_P${String(page).padStart(3, '0')}` : `QCF2${String(page).padStart(3, '0')}`;
  const fontUrl = currentVersion === "v1"
    ? `https://cdn.jsdelivr.net/gh/dickymiswardi/quran/fonts/${fontName}.TTF`
    : `https://cdn.jsdelivr.net/gh/tafsirnetlifyapp/quran@refs/heads/main/fontsglyphvs/${fontName}.ttf`;

  const apiField = currentVersion === "v1" ? "code_v1" : "code_v2";
  const data = await fetch(`https://api.quran.com/api/v4/verses/by_key/${key}?words=true&word_fields=${apiField}`).then(r => r.json());
  const words = data.verse.words.map(w => ({ arabic: w[apiField] || w.text, id: w.id }));

  const style = document.createElement("style");
  style.textContent = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}') format('truetype'); }`;
  document.head.appendChild(style);

  const div = document.createElement("div");
  div.className = "page-container";
  div.style.fontFamily = fontName;
  container.appendChild(div);

  await document.fonts.load(`1em ${fontName}`);
  const line = document.createElement("div");

  const selectedWords = words.slice(ws - 1, we);
  selectedWords.forEach(word => {
    const span = document.createElement("span");
    span.className = "word";
    span.innerText = word.arabic;
    line.appendChild(span);
    line.appendChild(document.createTextNode(" "));
  });

  div.appendChild(line);

  const transId = wordTranslationId.value;
  if (transId !== "0") {
    try {
      const langCode = transId === "33" ? "id" : "en";
      const r = await fetch(`https://api.quran.com/api/v4/verses/by_key/${key}?words=true&language=${langCode}&translations=${transId}`);
      const j = await r.json();
      const wordsData = j.verse.words;
      const wordTranslations = wordsData.slice(ws - 1, we).map(w => w.translation?.text || "");
      const perKataDiv = document.createElement("div");
      perKataDiv.className = "translation";
      perKataDiv.textContent = wordTranslations.join(" ");
      div.appendChild(perKataDiv);
    } catch (e) {
      console.error("Gagal ambil terjemah perkata:", e);
    }
  }

  div.style.display = "block";
  requestAnimationFrame(() => div.style.opacity = "1");
}

function setVersion(v) {
  currentVersion = v;
  loadAyat();
}

// Popup Functions
function showPopup() {
  const s = surahSelect.value;
  const a = ayahSelect.value;
  const lang = wordTranslationId.value === "33" ? "indonesian_complex" : "english_rwwad";
  fetch(`https://quranenc.com/api/v1/translation/aya/${lang}/${s}/${a}`)
    .then(r => r.json())
    .then(j => {
      const text = j.result?.translation || "Tidak ditemukan.";
      document.getElementById("popupText").textContent = text;
      document.getElementById("popup").style.display = "flex";
    })
    .catch(e => {
      console.error("Gagal ambil terjemah lengkap:", e);
      document.getElementById("popupText").textContent = "Gagal mengambil terjemahan.";
      document.getElementById("popup").style.display = "flex";
    });
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
}

updateAyahDropdown();
</script>
</body>
</html>
